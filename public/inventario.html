<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inventario</title>
</head>
<body>
  <h1>Inventario</h1>
  <div id="bienvenida"></div>
  <form id="productoForm">
    <input type="hidden" name="id" id="productoId">
    <label>Nombre: <input type="text" name="nombre" required></label>
    <label>Precio: <input type="number" name="precio" step="0.01" required></label>
    <label>Stock: <input type="number" name="stock" required></label>
    <button type="submit" id="btnGuardar">Agregar Producto</button>
    <button type="button" id="btnCancelar" style="display:none;">Cancelar edición</button>
  </form>
  <div id="productoMensaje"></div>
  <h3>Productos registrados</h3>
  <ul id="listaProductos"></ul>
  <button onclick="logout()">Cerrar sesión</button>
  <script>
    // Verifica si hay usuario logueado
    const usuario = JSON.parse(localStorage.getItem('usuarioLogueado'));
    if (!usuario) {
      window.location.href = "login.html";
    } else {
      document.getElementById('bienvenida').textContent = "Bienvenido, " + usuario.username;
    }

    // Agregar o editar producto
    document.getElementById('productoForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const id = document.getElementById('productoId').value;
      const nombre = this.nombre.value;
      const precio = parseFloat(this.precio.value);
      const stock = parseInt(this.stock.value);

      let res;
      if (id) {
        // Editar producto
        res = await fetch(`/api/productos/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre, precio, stock })
        });
      } else {
        // Agregar producto
        res = await fetch('/api/productos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre, precio, stock })
        });
      }

      const productoMensaje = document.getElementById('productoMensaje');
      if (res.ok) {
        productoMensaje.textContent = id ? "Producto editado correctamente" : "Producto agregado correctamente";
        productoMensaje.style.color = "green";
        this.reset();
        document.getElementById('productoId').value = '';
        document.getElementById('btnGuardar').textContent = 'Agregar Producto';
        document.getElementById('btnCancelar').style.display = 'none';
        cargarProductos();
      } else {
        const error = await res.text();
        productoMensaje.textContent = `Error: ${error}`;
        productoMensaje.style.color = "red";
      }
    });

    // Cancelar edición
    document.getElementById('btnCancelar').addEventListener('click', function() {
      document.getElementById('productoForm').reset();
      document.getElementById('productoId').value = '';
      document.getElementById('btnGuardar').textContent = 'Agregar Producto';
      this.style.display = 'none';
      document.getElementById('productoMensaje').textContent = '';
    });

    // Cargar productos en la lista
    async function cargarProductos() {
      const res = await fetch('/api/productos');
      const productos = await res.json();
      const ul = document.getElementById('listaProductos');
      ul.innerHTML = '';
      productos.forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.nombre} - $${p.precio} (${p.stock} unidades) `;
        // Botón Editar
        const btnEditar = document.createElement('button');
        btnEditar.textContent = 'Editar';
        btnEditar.onclick = () => editarProducto(p);
        li.appendChild(btnEditar);
        // Botón Eliminar
        const btnEliminar = document.createElement('button');
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.onclick = () => eliminarProducto(p.id);
        li.appendChild(btnEliminar);
        ul.appendChild(li);
      });
    }
    cargarProductos();

    // Editar producto (cargar datos en el formulario)
    function editarProducto(producto) {
      document.getElementById('productoId').value = producto.id;
      document.getElementById('productoForm').nombre.value = producto.nombre;
      document.getElementById('productoForm').precio.value = producto.precio;
      document.getElementById('productoForm').stock.value = producto.stock;
      document.getElementById('btnGuardar').textContent = 'Guardar Cambios';
      document.getElementById('btnCancelar').style.display = 'inline';
      document.getElementById('productoMensaje').textContent = '';
    }

    // Eliminar producto
    async function eliminarProducto(id) {
      if (!confirm('¿Seguro que deseas eliminar este producto?')) return;
      const res = await fetch(`/api/productos/${id}`, { method: 'DELETE' });
      if (res.ok) {
        cargarProductos();
      } else {
        alert('Error al eliminar el producto');
      }
    }

    function logout() {
      localStorage.removeItem('usuarioLogueado');
      window.location.href = "login.html";
    }
  </script>
</body>
</html>